---
date: 2026-03-02
week: 2주차
phase: 백엔드 완성
tags: [lifespeech, planner, dev]
---

# 2026-03-02 (월) — 2주차 D1

> **근무:** 10:00 ~ 19:00 · 실 작업 **8시간**
> **목표:** 네이버 CSV 업로드 API + 반 관리 API

---

## 시간 블록

| 시간 | 작업 | 예상 | 완료 기준 |
|------|------|------|-----------|
| 10:00–11:30 | CSV 파서 구현 (iconv-lite + 30컬럼 매핑) | 1.5h | 파싱 결과 콘솔 출력 확인 |
| 11:30–12:00 | POST /reservations/csv-upload 엔드포인트 | 0.5h | 파일 업로드 받기 성공 |
| 12:00–13:00 | 🍽️ 점심 | | |
| 13:00–14:30 | DB upsert 로직 (중복 체크 + 회원 자동 생성) | 1.5h | 업로드 → DB 저장 확인 |
| 14:30–15:30 | 반 관리 CRUD (GET/POST/PATCH /classes) | 1h | 3개 엔드포인트 Postman 통과 |
| 15:30–17:00 | 실제 네이버 CSV 10건 업로드 테스트 | 1.5h | Supabase Table Editor 확인 |
| 17:00–18:00 | 중복 업로드 방지 테스트 | 1h | 동일 파일 2번 → 중복 없음 |
| 18:00–19:00 | 에러 처리 + GitHub 커밋 | 1h | |

---

## 작업 체크리스트

### CSV 업로드 API
- [ ] `POST /reservations/csv-upload`
  - EUC-KR / UTF-8 BOM 인코딩 자동 감지 (iconv-lite)
  - 30컬럼 파싱 → reservations + members upsert
  - 완료 기준: 실제 네이버 CSV 10건 업로드 → DB 저장 확인
- [ ] CSV 중복 체크 (naver_booking_id 기준 SKIP)
  - 완료 기준: 동일 파일 2번 업로드 → 중복 없음
- [ ] 전화번호로 기존 회원 매칭 (없으면 자동 생성)
- [ ] 파싱 결과 반환: `{ total, created, skipped, errors }`

### 반 관리 CRUD
- [ ] `GET /classes` — 반 목록, type 필터 (group/1to1/director)
- [ ] `POST /classes` — 반 생성
- [ ] `PATCH /classes/:id` — 반 정보 수정

---

## 🤖 Claude 개발 요청 순서

### 요청 1 — CSV 파서 + 업로드 엔드포인트
```
네이버 예약 CSV를 파싱해서 DB에 저장하는 API를 만들어줘.
src/routes/reservations.ts에 추가.

POST /reservations/csv-upload
- multipart/form-data, 파일 필드명: file
- iconv-lite로 EUC-KR / UTF-8 BOM 인코딩 자동 감지 후 디코딩
- 12-네이버예약-CSV-매핑 문서 기준 30컬럼 파싱

파싱 후 처리:
1. naver_booking_id 기준 중복 확인 → 있으면 SKIP
2. 전화번호로 members 테이블 조회 → 없으면 신규 생성 (upsert)
3. reservations 테이블에 INSERT

응답: { total: N, created: N, skipped: N, errors: [] }

패키지: @fastify/multipart, iconv-lite, papaparse (또는 csv-parse)
```

### 요청 2 — 반 관리 CRUD
```
반(classes) CRUD API를 만들어줘. src/routes/classes.ts

1. GET /classes
   - query: type(group/1to1/director), page, limit
   - instructor 정보 JOIN 포함

2. POST /classes
   - body: { name, type, instructor_id?, max_capacity, sessions }
   - 응답: 201 { id, ...}

3. PATCH /classes/:id
   - body: partial update
   - 없는 ID → 404

requireRole('admin') 적용.
```

### 요청 3 — CSV 컬럼 매핑 확인 (실제 CSV 붙여넣기 후)
```
아래는 실제 네이버 예약 CSV 헤더야:
[실제 CSV 첫 줄 붙여넣기]

이 컬럼들을 우리 DB 필드에 어떻게 매핑해야 하는지 알려줘.
그리고 파싱 코드에서 빠진 컬럼이 있으면 추가해줘.
```

---

## ✅ 오늘 내가 직접 확인할 것

**CSV 업로드 테스트 (Postman)**
- [ ] Postman → `POST {API}/reservations/csv-upload`
  - Body: form-data, key=file, Type=File, 실제 네이버 CSV 선택
  - 전송 → `{ "total": 10, "created": 10, "skipped": 0 }` 확인
- [ ] Supabase → Table Editor → reservations 테이블 → 10건 생성 확인
- [ ] members 테이블 → 새 회원 자동 생성 확인

**중복 업로드 테스트**
- [ ] 같은 CSV 파일 다시 업로드 → `{ "total": 10, "created": 0, "skipped": 10 }` 확인

**반 CRUD 테스트**
- [ ] `POST {API}/classes` → 반 1개 생성 확인
- [ ] `GET {API}/classes` → 방금 만든 반 목록 확인

**❌ 막혔을 때**
- 인코딩 깨짐 → EUC-KR 감지 로직 확인, CSV를 UTF-8로 다시 저장해서 테스트
- 중복이 제거 안 됨 → naver_booking_id UNIQUE 제약 확인

---

## 작업 로그

| 시간 | 작업 내용 | 비고 |
|------|-----------|------|
| 10:00 | | |
| 10:30 | | |
| 11:00 | | |
| 11:30 | | |
| 13:00 | | |
| 13:30 | | |
| 14:00 | | |
| 14:30 | | |
| 15:00 | | |
| 15:30 | | |
| 16:00 | | |
| 17:00 | | |
| 18:00 | | |

---

## 메모 / 이슈

-
